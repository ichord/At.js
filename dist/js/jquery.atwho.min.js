/*! jquery.atwho - v0.2.0 - 2013-04-01
* http://ichord.github.com/At.js/
* Copyright (c) 2013 ichord; Licensed MIT */
(function(){(function(e){return typeof define=="function"&&define.amd?define(["jquery"],e):e(window.jQuery)})(function(e){var t,n,r,i,s;return i={DOWN:40,UP:38,ESC:27,TAB:9,ENTER:13},n={data_refactor:function(t){return e.isArray(t)?e.map(t,function(t,n){return e.isPlainObject(t)||(t={name:t}),t}):t},matcher:function(e,t){var n,r,i;return i=new RegExp(e+"([A-Za-z0-9_+-]*)$|"+e+"([^\\x00-\\xff]*)$","gi"),n=i.exec(t),r=null,n&&(r=n[2]?n[2]:n[1]),r},filter:function(t,n,r){var i=this;return e.map(n,function(n,i){var s;s=e.isPlainObject(n)?n[r]:n;if(s.toLowerCase().indexOf(t)>=0)return n})},remote_filter:function(t,n,r){return e.ajax(n,{data:t,success:function(e){return r(e)}})},sorter:function(e,t,n){var r,i,s,o,u;if(!e)return t.sort(function(e,t){return e[n].toLowerCase()>t[n].toLowerCase()?1:-1});i=[];for(o=0,u=t.length;o<u;o++)r=t[o],s=r[n],r.atwho_order=s.toLowerCase().indexOf(e),i.push(r);return i.sort(function(e,t){return e.atwho_order-t.atwho_order}),i=function(){var e,t,n;n=[];for(e=0,t=i.length;e<t;e++)r=i[e],delete r.atwho_order,n.push(r);return n}()},tpl_eval:function(e,t){var n;try{return n=e.replace(/\$\{([^\}]*)\}/g,function(e,n,r){return t[n]})}catch(r){return""}},highlighter:function(e,t){return t?e.replace(new RegExp(">\\s*(\\w*)("+t.replace("+","\\+")+")(\\w*)\\s*<","ig"),function(e,t,n,r){return"> "+t+"<strong>"+n+"</strong>"+r+" <"}):e},selector:function(e){if(e.length>0)return this.replace_str(e.data("value")||"")}},t=function(){function t(t){this.settings={},this.pos=0,this.flags=null,this.current_flag=null,this.query=null,this.$inputor=e(t),this.view=new s(this,this.$el),this.listen()}return t.prototype.listen=function(){var e=this;return this.$inputor.on("keyup.atwho",function(t){return e.on_keyup(t)}).on("keydown.atwho",function(t){return e.on_keydown(t)}).on("scroll.atwho",function(t){return e.view.hide()}).on("blur.atwho",function(t){return e.view.hide(e.get_opt("display_timeout"))})},t.prototype.reg=function(t,n){var r;return this.current_flag=t,r=this.settings[t]?this.settings[t]=e.extend({},this.settings[t],n):this.settings[t]=e.extend({},e.fn.atwho["default"],n),r.data=this.callbacks("data_refactor").call(this,r.data),this},t.prototype.trigger=function(e,t){return t||(t=[]),t.push(this),this.$inputor.trigger(""+e+".atwho",t)},t.prototype.data=function(e){return e?this.$inputor.data("atwho-data",e):this.$inputor.data("atwho-data")},t.prototype.callbacks=function(e){var t;return t=this.get_opt("callbacks")[e],t||(t=n[e]),t},t.prototype.get_opt=function(e,t){try{return this.settings[this.current_flag][e]}catch(n){return null}},t.prototype.rect=function(){var e,t,n;return e=this.$inputor.caret("offset",this.pos-1),document.selection?n=t=-2:(t=0,n=2),{left:e.left+t,top:e.top+t,bottom:e.top+e.height+n}},t.prototype.catch_query=function(){var t,n,r,i,s,o,u=this;return n=this.$inputor.val(),t=this.$inputor.caret("pos"),o=n.slice(0,t),i=null,e.each(this.settings,function(e,t){i=u.callbacks("matcher").call(u,e,o);if(i!=null)return u.current_flag=e,!1}),typeof i=="string"&&i.length<=20?(s=t-i.length,r=s+i.length,this.pos=s,i={text:i.toLowerCase(),head_pos:s,end_pos:r},this.trigger("matched",[this.current_flag,i.text])):this.view.hide(),this.query=i},t.prototype.replace_str=function(e){var t,n,r,i,s;return t=this.$inputor,r=t.val(),n=this.get_opt("display_flag")?0:this.current_flag.length,i=r.slice(0,(this.query.head_pos||0)-n),s=""+i+e+" "+r.slice(this.query.end_pos||0),t.val(s),t.caret("pos",i.length+e.length+1),t.change()},t.prototype.on_keyup=function(t){switch(t.keyCode){case i.ESC:t.preventDefault(),this.view.hide();break;case i.DOWN:case i.UP:e.noop();break;default:this.look_up()}return t.stopPropagation()},t.prototype.on_keydown=function(t){if(!this.view.visible())return;switch(t.keyCode){case i.ESC:t.preventDefault(),this.view.hide();break;case i.UP:t.preventDefault(),this.view.prev();break;case i.DOWN:t.preventDefault(),this.view.next();break;case i.TAB:case i.ENTER:if(!this.view.visible())return;t.preventDefault(),this.view.choose();break;default:e.noop()}return t.stopPropagation()},t.prototype.render_view=function(e){var t;return t=this.get_opt("search_key"),e=this.callbacks("sorter").call(this,this.query.text,e,t),e=e.slice(0,this.get_opt("limit")),this.data(e),this.view.render(e)},t.prototype.remote_call=function(t,n){var r,i;return r={limit:this.get_opt("limit")},r[this.get_opt("search_term")]=n.text,i=function(e){return this.render_view(e)},i=e.proxy(i,this),this.callbacks("remote_filter").call(this,r,t,i)},t.prototype.look_up=function(){var t,n,r;return n=this.catch_query(),n?(t=this.get_opt("data"),r=this.get_opt("search_key"),typeof t=="string"?this.remote_call(t,n):(t=this.callbacks("filter").call(this,n.text,t,r))?this.render_view(t):this.view.hide(),e.noop()):!1},t}(),s=function(){function t(t){this.controller=t,this.id=this.controller.get_opt("view_id")||"at-view",this.timeout_id=null,this.$el=e("#"+this.id),this.create_view()}return t.prototype.create_view=function(){var t,n,r=this;if(this.exist())return;return n="<div id='"+this.id+"' class='at-view'><ul id='"+this.id+"-ul'></ul></div>",e("body").append(n),this.$el=e("#"+this.id),t=this.$el.find("ul"),t.on("mouseenter.view","li",function(n){return t.find(".cur").removeClass("cur"),e(n.currentTarget).addClass("cur")}).on("click",function(e){return e.stopPropagation(),e.preventDefault(),r.$el.data("_view").choose()})},t.prototype.exist=function(){return e("#"+this.id).length>0},t.prototype.visible=function(){return this.$el.is(":visible")},t.prototype.choose=function(){var e;return e=this.$el.find(".cur"),this.controller.callbacks("selector").call(this.controller,e),this.controller.trigger("choose",[e]),this.hide()},t.prototype.reposition=function(){var t,n;return n=this.controller.rect(),n.bottom+this.$el.height()-e(window).scrollTop()>e(window).height()&&(n.bottom=n.top-this.$el.height()),t={left:n.left,top:n.bottom},this.$el.offset(t),this.controller.trigger("reposition",[t])},t.prototype.next=function(){var t,n;return t=this.$el.find(".cur").removeClass("cur"),n=t.next(),n.length||(n=e(this.$el.find("li")[0])),n.addClass("cur")},t.prototype.prev=function(){var e,t;return e=this.$el.find(".cur").removeClass("cur"),t=e.prev(),t.length||(t=this.$el.find("li").last()),t.addClass("cur")},t.prototype.show=function(){return this.visible()||this.$el.show(),this.reposition()},t.prototype.hide=function(e){var t,n=this;if(!isNaN(e))return t=function(){return n.hide()},clearTimeout(this.timeout_id),this.timeout_id=setTimeout(t,e);if(this.visible())return this.$el.hide()},t.prototype.clear=function(){return this.$el.find("ul").empty()},t.prototype.render=function(t){var n,i,s=this;return e.isArray(t)?t.length<=0?(this.hide(),!0):(this.clear(),this.$el.data("_view",this),n=this.$el.find("ul"),i=this.controller.get_opt("tpl",r),e.each(t,function(t,r){var o,u;return u=s.controller.callbacks("tpl_eval").call(s.controller,i,r),o=e(s.controller.callbacks("highlighter").call(s.controller,u,s.controller.query.text)),o.data("info",r),n.append(o)}),this.show(),n.find("li:eq(0)").addClass("cur")):!1},t}(),r="<li data-value='${name}'>${name}</li>",e.fn.atwho=function(n,r){return this.filter("textarea, input").each(function(){var i,s;return i=e(this),s=i.data("atwho"),s||i.data("atwho",s=new t(this)),s.reg(n,r)})},e.fn.atwho.Controller=t,e.fn.atwho.View=s,e.fn.atwho["default"]={data:null,search_key:"name",search_term:"q",callbacks:n,limit:5,display_flag:!0,display_timeout:300,tpl:r}})}).call(this),function(){(function(e){return typeof define=="function"&&define.amd?define(["jquery"],e):e(window.jQuery)})(function(e){"use strict";var t,n,r,i;return i="caret",t=function(){function t(e){this.$inputor=e,this.domInputor=this.$inputor[0]}return t.prototype.getPos=function(){var e,t,n,r,i,s,o,u,a;return n=this.domInputor,n.focus(),document.selection?(o=document.selection.createRange(),s=0,o&&o.parentElement()===n&&(i=n.value.replace(/\r\n/g,"\n"),r=i.length,a=n.createTextRange(),a.moveToBookmark(o.getBookmark()),t=n.createTextRange(),t.collapse(!1),a.compareEndPoints("StartToEnd",t)>-1?u=e=r:(u=-a.moveStart("character",-r),e=-a.moveEnd("character",-r)))):u=n.selectionStart,u},t.prototype.setPos=function(e){var t,n;return t=this.domInputor,document.selection?(n=t.createTextRange(),n.move("character",e),n.select()):t.setSelectionRange(e,e)},t.prototype.getPosition=function(e){var t,r,i,s,o,u,a,f,l;return t=this.$inputor,i=function(e){return e.replace(/</g,"&lt").replace(/>/g,"&gt").replace(/`/g,"&#96").replace(/"/g,"&quot").replace(/\r\n|\r|\n/g,"<br />")},e=e||this.getPos(),a=t.val().slice(0,e),o="<span>"+i(a)+"</span>",o+="<span id='caret'>|</span>",u=new n(t),r=u.create(o).rect(),f=r.left-t.scrollLeft(),l=r.top-t.scrollTop(),s=r.height,{left:f,top:l,height:s}},t.prototype.getOffset=function(t){var n,r,i,s,o,u,a;return n=this.$inputor,document.selection?(o=this.domInputor.createRange(),t&&o.move("character",t),u=o.boundingLeft+n.scrollLeft(),a=o.boundingTop+e(window).scrollTop()+n.scrollTop(),r=o.boundingHeight):(i=n.offset(),s=this.getPosition(t),u=i.left+s.left,a=i.top+s.top,r=s.height),{left:u,top:a,height:r}},t}(),n=function(){function t(e){this.$inputor=e}return t.prototype.css_attr=["overflowY","height","width","paddingTop","paddingLeft","paddingRight","paddingBottom","marginTop","marginLeft","marginRight","marginBottom","fontFamily","borderStyle","borderWidth","wordWrap","fontSize","lineHeight","overflowX","text-align"],t.prototype.mirrorCss=function(){var t,n=this;return t={position:"absolute",left:-9999,top:0,zIndex:-2e4,"white-space":"pre-wrap"},e.each(this.css_attr,function(e,r){return t[r]=n.$inputor.css(r)}),t},t.prototype.create=function(t){return this.$mirror=e("<div></div>"),this.$mirror.css(this.mirrorCss()),this.$mirror.html(t),this.$inputor.after(this.$mirror),this},t.prototype.rect=function(){var e,t,n;return e=this.$mirror.find("#caret"),t=e.position(),n={left:t.left,top:t.top,height:e.height()},this.$mirror.remove(),n},t}(),r={pos:function(e){return e?this.setPos(e):this.getPos()},position:function(e){return this.getPosition(e)},offset:function(e){return this.getOffset(e)}},e.fn.caret=function(n){var i;return i=new t(this),r[n]?r[n].apply(i,Array.prototype.slice.call(arguments,1)):e.error("Method "+n+" does not exist on jQuery.caret")}})}.call(this);