/*! jquery.atwho - v0.2.0 - 2013-05-02
* http://ichord.github.com/At.js/
* Copyright (c) 2013 ichord; Licensed MIT */
(function(){var e=[].slice;(function(e){return typeof define=="function"&&define.amd?define(["jquery"],e):e(window.jQuery)})(function(t){var n,r,i,s,o,u,a,f;return u={DOWN:40,UP:38,ESC:27,TAB:9,ENTER:13},s={before_save:function(e){var n,r,i,s;if(!t.isArray(e))return e;s=[];for(r=0,i=e.length;r<i;r++)n=e[r],t.isPlainObject(n)?s.push(n):s.push({name:n});return s},matcher:function(e,t){var n,r;return e="(?:^|\\s)"+e.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),r=new RegExp(e+"([A-Za-z0-9_+-]*)$|"+e+"([^\\x00-\\xff]*)$","gi"),n=r.exec(t),n?n[2]||n[1]:null},filter:function(e,t,n){var r,i,s,o;o=[];for(i=0,s=t.length;i<s;i++)r=t[i],~r[n].toLowerCase().indexOf(e)&&o.push(r);return o},remote_filter:null,sorter:function(e,t,n){var r,i,s,o;if(!e)return t.sort(function(e,t){return e[n].toLowerCase()>t[n].toLowerCase()?1:-1});o=[];for(i=0,s=t.length;i<s;i++)r=t[i],r.atwho_order=r[n].toLowerCase().indexOf(e),r.atwho_order>-1&&o.push(r);return o.sort(function(e,t){return e.atwho_order-t.atwho_order})},tpl_eval:function(e,t){try{return e.replace(/\$\{([^\}]*)\}/g,function(e,n,r){return t[n]})}catch(n){return""}},highlighter:function(e,t){var n;return t?(n=new RegExp(">\\s*(\\w*)("+t.replace("+","\\+")+")(\\w*)\\s*<","ig"),e.replace(n,function(e,t,n,r){return"> "+t+"<strong>"+n+"</strong>"+r+" <"})):e},before_insert:function(e,t){return e}},a=function(){function n(e,t){this.context=e,this.key=t}var e;return e={},n.prototype.saved=function(){return this.fetch()>0},n.prototype.query=function(e,t){var n,r,i;n=this.fetch(),i=this.context.get_opt("search_key"),n=this.context.callbacks("filter").call(this.context,e,n,i);if(n&&n.length>0)return t(n);if(r=this.context.callbacks("remote_filter"))return r.call(this.context,e,t)},n.prototype.fetch=function(){return e[this.key]||[]},n.prototype.save=function(t){return e[this.key]=this.context.callbacks("before_save").call(this.context,t)},n.prototype.load=function(e){if(!this.saved()&&!!e)return this._load(e)},n.prototype.reload=function(e){return this._load(e)},n.prototype._load=function(e){var n=this;return typeof e=="string"?t.ajax(e,{dataType:"json"}).done(function(e){return n.save(e)}):this.save(e)},n}(),i=function(){function o(e){this.id=e.id||r(),this.settings={},this.pos=0,this.current_flag=null,this.query=null,this.the_flag={},this._views={},this._models={},this.$inputor=t(e),n.append(this.$el=t("<div id='atwho-ground-"+this.id+"'></div>")),this.listen()}var r,i;return i=0,r=function(){return i+=1},o.prototype.listen=function(){var e=this;return this.$inputor.on("keyup.atwho",function(t){return e.on_keyup(t)}).on("keydown.atwho",function(t){return e.on_keydown(t)}).on("scroll.atwho",function(t){var n;return(n=e.view)!=null?n.hide():void 0}).on("blur.atwho",function(t){var n;return(n=e.view)!=null?n.hide(e.get_opt("display_timeout")):void 0})},o.prototype.set_context_for=function(e){return e=this.current_flag=this.the_flag[e],this.view=this._views[e],this.model=this._models[e],this},o.prototype.reg=function(e,n){var r;return r=this.settings[e]=t.extend({},this.settings[e]||t.fn.atwho["default"],n),this.set_context_for(e=(r.alias?this.the_flag[r.alias]=e:void 0,this.the_flag[e]=e)),(this._models[e]=new a(this,e)).reload(r.data),this._views[e]=new f(this,e),this},o.prototype.trigger=function(e,t){var n,r;return t.push(this),n=this.get_opt("alias"),r=n?""+e+"-"+n+".atwho":""+e+".atwho",this.$inputor.trigger(r,t)},o.prototype.super_call=function(){var n,r;r=arguments[0],n=2<=arguments.length?e.call(arguments,1):[];try{return s[r].apply(this,n)}catch(i){return t.error(""+i+" Or maybe At.js doesn't have function "+r)}},o.prototype.callbacks=function(e){return this.get_opt("callbacks")[e]||s[e]},o.prototype.get_opt=function(e,t){try{return this.settings[this.current_flag][e]}catch(n){return null}},o.prototype.rect=function(){var e,t;return e=this.$inputor.caret("offset",this.pos-1),t=document.selection?0:2,{left:e.left,top:e.top,bottom:e.top+e.height+t}},o.prototype.catch_query=function(){var e,n,r,i,s,o,u,a=this;return n=this.$inputor.val(),e=this.$inputor.caret("pos"),o=n.slice(0,e),i=null,t.map(this.settings,function(e){var t;t=a.callbacks("matcher").call(a,e.at,o);if(t!=null)return i=t,a.set_context_for(e.at)}),typeof i=="string"&&i.length<=this.get_opt("max_len",20)?(s=e-i.length,r=s+i.length,this.pos=s,i={text:i.toLowerCase(),head_pos:s,end_pos:r},this.trigger("matched",[this.current_flag,i.text])):(u=this.view)!=null&&u.hide(),this.query=i},o.prototype.insert=function(e){var t,n,r,i,s;return t=this.$inputor,e=""+e,r=t.val(),n=this.get_opt("display_flag")?0:this.current_flag.length,i=r.slice(0,(this.query.head_pos||0)-n),s=""+i+e+" "+r.slice(this.query.end_pos||0),t.val(s),t.caret("pos",i.length+e.length+1),t.change()},o.prototype.on_keyup=function(e){switch(e.keyCode){case u.ESC:e.preventDefault(),this.view.hide();break;case u.DOWN:case u.UP:t.noop();break;default:this.look_up()}},o.prototype.on_keydown=function(e){var n;if((n=this.view)!=null?!n.visible():!void 0)return;switch(e.keyCode){case u.ESC:e.preventDefault(),this.view.hide();break;case u.UP:e.preventDefault(),this.view.prev();break;case u.DOWN:e.preventDefault(),this.view.next();break;case u.TAB:case u.ENTER:if(!this.view.visible())return;e.preventDefault(),this.view.choose();break;default:t.noop()}},o.prototype.render_view=function(e){var t;return t=this.get_opt("search_key"),e=this.callbacks("sorter").call(this,this.query.text,e.slice(0,1001),t),this.view.render(e.slice(0,this.get_opt("limit")))},o.prototype.look_up=function(){var e,n;if(!(e=this.catch_query()))return;return n=function(e){return e?this.render_view(e):this.view.hide()},this.model.query(e.text,t.proxy(n,this))},o}(),f=function(){function e(e,n){this.context=e,this.key=n,this.id=this.context.get_opt("alias")||"at-view-"+this.key.charCodeAt(0),this.$el=t("<div id='"+this.id+"' class='atwho-view'><ul id='"+this.id+"-ul' class='atwho-view-url'></ul></div>"),this.timeout_id=null,this.context.$el.append(this.$el),this.bind_event()}return e.prototype.bind_event=function(){var e,n=this;return e=this.$el.find("ul"),e.on("mouseenter.view","li",function(n){return e.find(".cur").removeClass("cur"),t(n.currentTarget).addClass("cur")}).on("click",function(e){return n.choose(),e.preventDefault()})},e.prototype.visible=function(){return this.$el.is(":visible")},e.prototype.choose=function(){var e;return e=this.$el.find(".cur"),this.context.insert(this.context.callbacks("before_insert").call(this.context,e.data("value"),e)),this.context.trigger("inserted",[e]),this.hide()},e.prototype.reposition=function(){var e,n;return n=this.context.rect(),n.bottom+this.$el.height()-t(window).scrollTop()>t(window).height()&&(n.bottom=n.top-this.$el.height()),e={left:n.left,top:n.bottom},this.$el.offset(e),this.context.trigger("reposition",[e])},e.prototype.next=function(){var e,t;return e=this.$el.find(".cur").removeClass("cur"),t=e.next(),t.length||(t=this.$el.find("li:first")),t.addClass("cur")},e.prototype.prev=function(){var e,t;return e=this.$el.find(".cur").removeClass("cur"),t=e.prev(),t.length||(t=this.$el.find("li:last")),t.addClass("cur")},e.prototype.show=function(){return this.visible()||this.$el.show(),this.reposition()},e.prototype.hide=function(e){var t,n=this;return isNaN(e&&this.visible())?this.$el.hide():(t=function(){return n.hide()},clearTimeout(this.timeout_id),this.timeout_id=setTimeout(t,e))},e.prototype.render=function(e){var n,r,i,s,u,a,f;if(!t.isArray(e||e.length<=0)){this.hide();return}this.$el.find("ul").empty(),r=this.$el.find("ul"),u=this.context.get_opt("tpl",o);for(a=0,f=e.length;a<f;a++)i=e[a],s=this.context.callbacks("tpl_eval").call(this.context,u,i),n=t(this.context.callbacks("highlighter").call(this.context,s,this.context.query.text)),n.data("atwho-info",i),r.append(n);return this.show(),r.find("li:first").addClass("cur")},e}(),o="<li data-value='${name}'>${name}</li>",r={init:function(e){var n,r;return r=(n=t(this)).data("atwho"),r||n.data("atwho",r=new i(this)),r.reg(e.at,e)},load:function(e,t){return this.set_context_for(e),this.model.load(t)},run:function(){return this.look_up()}},n=t("<div id='atwho-container'></div>"),t.fn.atwho=function(e){var i;return i=arguments,t("body").append(n),this.filter("textarea, input").each(function(){return typeof e=="object"||!e?r.init.apply(this,i):r[e]?r[e].apply(t(this).data("atwho"),Array.prototype.slice.call(i,1)):t.error("Method "+e+" does not exist on jQuery.caret")})},t.fn.atwho["default"]={at:void 0,alias:void 0,data:null,tpl:o,callbacks:s,search_key:"name",limit:5,max_len:20,display_flag:!0,display_timeout:300}})}).call(this),function(){(function(e){return typeof define=="function"&&define.amd?define(["jquery"],e):e(window.jQuery)})(function(e){"use strict";var t,n,r,i;return i="caret",t=function(){function t(e){this.$inputor=e,this.domInputor=this.$inputor[0]}return t.prototype.getPos=function(){var e,t,n,r,i,s,o,u,a;return n=this.domInputor,n.focus(),document.selection?(o=document.selection.createRange(),s=0,o&&o.parentElement()===n&&(i=n.value.replace(/\r\n/g,"\n"),r=i.length,a=n.createTextRange(),a.moveToBookmark(o.getBookmark()),t=n.createTextRange(),t.collapse(!1),a.compareEndPoints("StartToEnd",t)>-1?u=e=r:(u=-a.moveStart("character",-r),e=-a.moveEnd("character",-r)))):u=n.selectionStart,u},t.prototype.setPos=function(e){var t,n;return t=this.domInputor,document.selection?(n=t.createTextRange(),n.move("character",e),n.select()):t.setSelectionRange(e,e)},t.prototype.getPosition=function(e){var t,r,i,s,o,u,a,f,l;return t=this.$inputor,i=function(e){return e.replace(/</g,"&lt").replace(/>/g,"&gt").replace(/`/g,"&#96").replace(/"/g,"&quot").replace(/\r\n|\r|\n/g,"<br />")},e=e||this.getPos(),a=t.val().slice(0,e),o="<span>"+i(a)+"</span>",o+="<span id='caret'>|</span>",u=new n(t),r=u.create(o).rect(),f=r.left-t.scrollLeft(),l=r.top-t.scrollTop(),s=r.height,{left:f,top:l,height:s}},t.prototype.getOffset=function(t){var n,r,i,s,o,u,a;return n=this.$inputor,document.selection?(o=this.domInputor.createTextRange(),t&&o.move("character",t),u=o.boundingLeft+n.scrollLeft(),a=o.boundingTop+e(window).scrollTop()+n.scrollTop(),r=o.boundingHeight):(i=n.offset(),s=this.getPosition(t),u=i.left+s.left,a=i.top+s.top,r=s.height),{left:u,top:a,height:r}},t}(),n=function(){function t(e){this.$inputor=e}return t.prototype.css_attr=["overflowY","height","width","paddingTop","paddingLeft","paddingRight","paddingBottom","marginTop","marginLeft","marginRight","marginBottom","fontFamily","borderStyle","borderWidth","wordWrap","fontSize","lineHeight","overflowX","text-align"],t.prototype.mirrorCss=function(){var t,n=this;return t={position:"absolute",left:-9999,top:0,zIndex:-2e4,"white-space":"pre-wrap"},e.each(this.css_attr,function(e,r){return t[r]=n.$inputor.css(r)}),t},t.prototype.create=function(t){return this.$mirror=e("<div></div>"),this.$mirror.css(this.mirrorCss()),this.$mirror.html(t),this.$inputor.after(this.$mirror),this},t.prototype.rect=function(){var e,t,n;return e=this.$mirror.find("#caret"),t=e.position(),n={left:t.left,top:t.top,height:e.height()},this.$mirror.remove(),n},t}(),r={pos:function(e){return e?this.setPos(e):this.getPos()},position:function(e){return this.getPosition(e)},offset:function(e){return this.getOffset(e)}},e.fn.caret=function(n){var i;return i=new t(this),r[n]?r[n].apply(i,Array.prototype.slice.call(arguments,1)):e.error("Method "+n+" does not exist on jQuery.caret")}})}.call(this);